<!DOCTYPE html>
<html lang="en">

<body>

    <script src="libs/three.min.js"></script>

    <script type="module">

        import { ObjectControls } from './ObjectControls.js';
        
        const width = window.innerWidth / 2

        var renderer = new THREE.WebGLRenderer();
        var controls;
        var camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 1, 1000);
        var scene = new THREE.Scene();

        var spinImageMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff, vertexColors: true });
        var spinModelMaterial = new THREE.MeshPhongMaterial({ color: 0x49ef4, transparent: true, opacity: 0});

        var spinModelGeometry = new THREE.SphereGeometry(width/3, 16, 16);
        //new THREE.BoxGeometry(width/3, width/3, width/3);

        var spinImageGeometry = new THREE.BoxGeometry(width, width, width);

        var sampleHotspotGeometry = new THREE.SphereGeometry(10, 100, 100);
        var sampleHotspotMaterial = new THREE.MeshToonMaterial({ color: 0x49ef4, transparent: true });


        var textureLoader = new THREE.TextureLoader();
        var texture0 = textureLoader.load('front.png');
        var texture1 = textureLoader.load('back.png');
        var texture2 = textureLoader.load('sidel.png');
        var texture3 = textureLoader.load('sider.png');

        var cubeMaterials = [
            new THREE.MeshBasicMaterial({ map: texture2, side: THREE.DoubleSide }),
            new THREE.MeshBasicMaterial({ map: texture3, side: THREE.DoubleSide }), //done
            new THREE.MeshBasicMaterial({ color: 0xaaa, vertexColors: true }),
            new THREE.MeshBasicMaterial({ map: texture2, side: THREE.DoubleSide }),
            new THREE.MeshBasicMaterial({ map: texture0, side: THREE.DoubleSide }), //done
            new THREE.MeshBasicMaterial({ map: texture1, side: THREE.DoubleSide })
        ];


        var spinImage = new THREE.Mesh(spinImageGeometry, cubeMaterials);
        var spinModel = new THREE.Mesh(spinModelGeometry, spinModelMaterial);
        var hotspot = new THREE.Mesh(sampleHotspotGeometry, sampleHotspotMaterial);

        var ambient = new THREE.AmbientLight(0xffffff);



        function init() {

            camera.position.set(0, 0, 0);
            camera.position.z = -spinImage.geometry.parameters.depth*2.3

            spinImage.position.set(0, 0, 0);
            spinModel.position.set(0, 0, -spinImage.geometry.parameters.depth)

            camera.lookAt(spinImage.position);

            scene.add(camera);
            scene.add(spinImage);
            scene.add(spinModel)
            spinModel.add(hotspot);
            hotspot.position.set(50, 0, -spinModel.geometry.parameters.radius);
            scene.add(ambient);

            document.body.appendChild(renderer.domElement);
            renderer.setSize(window.innerWidth, window.innerHeight);

            /** instantiate ObjectControls**/
            controls = new ObjectControls(camera, renderer.domElement, spinImage);
            controls = new ObjectControls(camera, renderer.domElement, spinModel);

            window.addEventListener('resize', onResize, false);
        }

        function checkPinVisibility() {
            let hotspotPosition = spinModel.children[0].getWorldPosition();
            let parentPosition = spinModel.getWorldPosition();
            console.log(hotspotPosition.z, parentPosition.z)
            if (hotspotPosition.z <= parentPosition.z || Math.abs(hotspotPosition.z) - Math.abs(parentPosition.z) == 0) {
                spinModel.children[0].material.opacity = 1;

            }
            else
                spinModel.children[0].material.opacity = 0;
        }

        function onResize() {

            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = (window.innerWidth / window.innerHeight);
            camera.updateProjectionMatrix();

        }

        function animate() {
            requestAnimationFrame(animate);
            render();
        }

        function render() {
            checkPinVisibility()

            renderer.render(scene, camera);
        }



        init();
        animate();

    </script>
</body>

</html>